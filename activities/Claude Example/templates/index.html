<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Imputer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
</head>
<body>
    <h1>CSV Imputer</h1>
    <input type="file" id="csvFile" accept=".csv" onchange="updateColumnList()">
    <select id="columnSelect" disabled>
        <option value="">Select a column to impute</option>
    </select>
    <button onclick="processFile()">Process CSV</button>
    <button id="downloadBtn" style="display:none;" onclick="downloadCSV()">Download Imputed CSV</button>
    <div id="result"></div>

    <script>
        let processedCSVData = null;

        function updateColumnList() {
            const fileInput = document.getElementById('csvFile');
            const columnSelect = document.getElementById('columnSelect');
            const file = fileInput.files[0];

            if (file) {
                Papa.parse(file, {
                    header: true,
                    preview: 1,
                    complete: function(results) {
                        columnSelect.innerHTML = '<option value="">Select a column to impute</option>';
                        results.meta.fields.forEach(field => {
                            const option = document.createElement('option');
                            option.value = field;
                            option.textContent = field;
                            columnSelect.appendChild(option);
                        });
                        columnSelect.disabled = false;
                    }
                });
            } else {
                columnSelect.innerHTML = '<option value="">Select a column to impute</option>';
                columnSelect.disabled = true;
            }
            document.getElementById('downloadBtn').style.display = 'none';
        }

        function processFile() {
            const fileInput = document.getElementById('csvFile');
            const columnSelect = document.getElementById('columnSelect');
            const file = fileInput.files[0];
            const columnToImpute = columnSelect.value;

            if (file && columnToImpute) {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('column_to_impute', columnToImpute);

                fetch('/process', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        document.getElementById('result').innerHTML = `Error: ${data.error}`;
                        document.getElementById('downloadBtn').style.display = 'none';
                    } else {
                        processedCSVData = data.data;
                        const parsedData = Papa.parse(data.data, {header: true}).data;
                        displayTable(parsedData);
                        document.getElementById('downloadBtn').style.display = 'inline-block';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('result').innerHTML = 'An error occurred while processing the file.';
                    document.getElementById('downloadBtn').style.display = 'none';
                });
            } else {
                document.getElementById('result').innerHTML = 'Please select a CSV file and a column to impute.';
                document.getElementById('downloadBtn').style.display = 'none';
            }
        }

        function displayTable(data) {
            const table = document.createElement('table');
            const header = table.createTHead();
            const headerRow = header.insertRow();
            
            // Create table headers
            Object.keys(data[0]).forEach(key => {
                const th = document.createElement('th');
                th.textContent = key;
                headerRow.appendChild(th);
            });

            // Create table rows
            const tbody = table.createTBody();
            data.forEach(row => {
                const tr = tbody.insertRow();
                Object.values(row).forEach(value => {
                    const td = tr.insertCell();
                    td.textContent = value;
                });
            });

            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '';
            resultDiv.appendChild(table);
        }

        function downloadCSV() {
            if (processedCSVData) {
                const formData = new FormData();
                formData.append('csv_data', processedCSVData);

                fetch('/download', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = 'imputed_data.csv';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                })
                .catch(error => console.error('Error:', error));
            }
        }
    </script>
</body>
</html>